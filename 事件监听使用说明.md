# ğŸ¯ load-more äº‹ä»¶ç›‘å¬ä½¿ç”¨è¯´æ˜

## âœ¨ æ–°ç‰¹æ€§ (v1.0.2+)

ç°åœ¨æ¨èä½¿ç”¨**äº‹ä»¶ç›‘å¬**æ–¹å¼å¤„ç†æ•°æ®åŠ è½½ï¼Œæ›¿ä»£å…¨å±€å‡½æ•°æ–¹å¼ï¼

---

## ğŸ“ ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶ç›‘å¬ï¼Ÿ

### âœ… äº‹ä»¶ç›‘å¬çš„ä¼˜åŠ¿

1. **ç¬¦åˆæ ‡å‡†**: ä½¿ç”¨åŸç”Ÿ DOM äº‹ä»¶ï¼Œä¸æ±¡æŸ“å…¨å±€å‘½åç©ºé—´
2. **ç±»å‹å®‰å…¨**: TypeScript å®Œç¾æ”¯æŒï¼Œæœ‰å®Œæ•´çš„ç±»å‹æç¤º
3. **æ›´æ¸…æ™°**: ä»£ç ç»„ç»‡æ›´å¥½ï¼Œä¸ä¾èµ–å…¨å±€å˜é‡
4. **ç°ä»£åŒ–**: ç¬¦åˆç°ä»£å‰ç«¯æ¡†æ¶çš„ä½¿ç”¨ä¹ æƒ¯

### âŒ å…¨å±€å‡½æ•°çš„é—®é¢˜

```javascript
// âŒ æ—§æ–¹å¼ï¼šéœ€è¦å…¨å±€å‡½æ•°
window.loadMore = function(component) { ... }
```

- æ±¡æŸ“å…¨å±€å‘½åç©ºé—´
- å®¹æ˜“å‘½åå†²çª
- ä¸ç¬¦åˆæ¨¡å—åŒ–å¼€å‘
- TypeScript æ”¯æŒè¾ƒå·®

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸç”Ÿ JavaScript

```html
<waterfall-flow id="waterfall" row-gap="10" column-gap="10">
  <!-- å†…å®¹ -->
</waterfall-flow>

<script>
  const waterfall = document.getElementById('waterfall');
  
  waterfall.addEventListener('load-more', (event) => {
    // ğŸ“Œ é‡è¦ï¼šé˜»æ­¢é»˜è®¤è¡Œä¸º
    event.preventDefault();
    
    // è·å–äº‹ä»¶æ•°æ®
    const { currentCount, finishLoading } = event.detail;
    
    console.log(`å½“å‰æœ‰ ${currentCount} ä¸ªé¡¹ç›®`);
    
    // åŠ è½½æ•°æ®
    fetch('/api/items?page=' + currentPage)
      .then(res => res.json())
      .then(data => {
        // æ·»åŠ æ–°é¡¹ç›®
        data.items.forEach(item => {
          const el = createItem(item);
          waterfall.appendChild(el);
        });
        
        // ğŸ“Œ å¿…é¡»ï¼šé€šçŸ¥åŠ è½½å®Œæˆ
        finishLoading(data.hasMore); // true = è¿˜æœ‰æ›´å¤šï¼Œfalse = æ²¡æœ‰äº†
      });
  });
</script>
```

### Vue 3 / Nuxt 4

```vue
<template>
  <waterfall-flow
    @load-more="handleLoadMore"
    :row-gap="10"
    :column-gap="10"
  >
    <div v-for="item in items" :key="item.id">
      {{ item.title }}
    </div>
  </waterfall-flow>
</template>

<script setup>
import { ref } from 'vue';
import 'wj-waterfall-flow';

const items = ref([]);
const currentPage = ref(0);

const handleLoadMore = async (event) => {
  const { currentCount, finishLoading } = event.detail;
  
  currentPage.value++;
  
  try {
    const response = await fetch(`/api/items?page=${currentPage.value}`);
    const data = await response.json();
    
    items.value.push(...data.items);
    
    // é€šçŸ¥åŠ è½½å®Œæˆ
    finishLoading(data.hasMore);
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    finishLoading(false);
  }
};
</script>
```

### React

```jsx
import { useEffect, useRef, useState } from 'react';
import 'wj-waterfall-flow';

function WaterfallDemo() {
  const [items, setItems] = useState([]);
  const waterfallRef = useRef(null);
  const currentPageRef = useRef(0);

  useEffect(() => {
    const waterfall = waterfallRef.current;
    if (!waterfall) return;

    const handleLoadMore = async (event) => {
      const { currentCount, finishLoading } = event.detail;
      
      currentPageRef.current++;
      
      try {
        const response = await fetch(`/api/items?page=${currentPageRef.current}`);
        const data = await response.json();
        
        setItems(prev => [...prev, ...data.items]);
        
        finishLoading(data.hasMore);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        finishLoading(false);
      }
    };

    waterfall.addEventListener('load-more', handleLoadMore);

    return () => {
      waterfall.removeEventListener('load-more', handleLoadMore);
    };
  }, []);

  return (
    <waterfall-flow ref={waterfallRef} row-gap="10" column-gap="10">
      {items.map(item => (
        <div key={item.id}>{item.title}</div>
      ))}
    </waterfall-flow>
  );
}
```

---

## ğŸ“š API è¯¦è§£

### äº‹ä»¶ï¼š`load-more`

å½“ç»„ä»¶éœ€è¦åŠ è½½æ›´å¤šæ•°æ®æ—¶è§¦å‘ã€‚

**äº‹ä»¶å¯¹è±¡** (`CustomEvent`)

```typescript
interface LoadMoreDetail {
  // å½“å‰å·²æœ‰çš„é¡¹ç›®æ•°é‡
  currentCount: number;
  
  // å®ŒæˆåŠ è½½çš„å›è°ƒå‡½æ•°
  finishLoading: (hasMore: boolean) => void;
}

event.detail: LoadMoreDetail
```

**é‡è¦æç¤ºï¼š**

1. âœ… **å¿…é¡»è°ƒç”¨ `event.preventDefault()`**ï¼Œå‘Šè¯‰ç»„ä»¶ä½ æ­£åœ¨å¤„ç†äº‹ä»¶
2. âœ… **å¿…é¡»è°ƒç”¨ `finishLoading(hasMore)`**ï¼Œé€šçŸ¥ç»„ä»¶åŠ è½½å®Œæˆ
   - `finishLoading(true)` - è¿˜æœ‰æ›´å¤šæ•°æ®
   - `finishLoading(false)` - æ²¡æœ‰æ›´å¤šæ•°æ®äº†

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

```javascript
waterfall.addEventListener('load-more', async (event) => {
  event.preventDefault();
  const { finishLoading } = event.detail;
  
  try {
    const data = await fetchData();
    // ... å¤„ç†æ•°æ®
    finishLoading(data.hasMore);
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ ‡è®°ä¸ºæ— æ›´å¤šæ•°æ®
    finishLoading(false);
  }
});
```

### 2. åŠ è½½çŠ¶æ€ç®¡ç† (Vue)

```vue
<script setup>
const isLoading = ref(false);

const handleLoadMore = async (event) => {
  isLoading.value = true;
  const { finishLoading } = event.detail;
  
  try {
    const data = await fetchData();
    items.value.push(...data.items);
    finishLoading(data.hasMore);
  } finally {
    isLoading.value = false;
  }
};
</script>
```

### 3. é˜²æŠ–å¤„ç†

```javascript
let loadingTimeout;

waterfall.addEventListener('load-more', (event) => {
  event.preventDefault();
  const { finishLoading } = event.detail;
  
  // æ¸…é™¤ä¹‹å‰çš„åŠ è½½
  clearTimeout(loadingTimeout);
  
  loadingTimeout = setTimeout(async () => {
    const data = await fetchData();
    // ... å¤„ç†æ•°æ®
    finishLoading(data.hasMore);
  }, 300);
});
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: æ•°æ®ä¸€ç›´é‡å¤åŠ è½½ï¼Ÿ

**åŸå› **: æ²¡æœ‰è°ƒç”¨ `finishLoading()` æˆ–è€…æ²¡æœ‰è°ƒç”¨ `event.preventDefault()`

```javascript
// âŒ é”™è¯¯
waterfall.addEventListener('load-more', (event) => {
  loadData(); // å¿˜è®°è°ƒç”¨ finishLoading
});

// âœ… æ­£ç¡®
waterfall.addEventListener('load-more', (event) => {
  event.preventDefault(); // 1. é˜»æ­¢é»˜è®¤è¡Œä¸º
  const { finishLoading } = event.detail;
  
  loadData().then(data => {
    // ... å¤„ç†
    finishLoading(true); // 2. é€šçŸ¥å®Œæˆ
  });
});
```

### Q2: ä¸ºä»€ä¹ˆè¦è°ƒç”¨ `event.preventDefault()`ï¼Ÿ

å› ä¸ºç»„ä»¶ä¼šæ£€æŸ¥äº‹ä»¶æ˜¯å¦è¢«é˜»æ­¢ï¼Œå¦‚æœæ²¡æœ‰é˜»æ­¢ï¼Œè¯´æ˜æ²¡æœ‰ç›‘å¬å™¨å¤„ç†ï¼Œç»„ä»¶ä¼šå°è¯•è°ƒç”¨å…¨å±€å‡½æ•°ä½œä¸ºåå¤‡ã€‚

```javascript
// ç»„ä»¶å†…éƒ¨é€»è¾‘
this.dispatchEvent(event);

if (!event.defaultPrevented) {
  // æ²¡æœ‰ç›‘å¬å™¨ï¼Œå°è¯•å…¨å±€å‡½æ•°
  window[onLoadMore]?.();
}
```

### Q3: Vue ä¸­ `@load-more` ä¸ç”Ÿæ•ˆï¼Ÿ

ç¡®ä¿ï¼š
1. ç»„ä»¶æ­£ç¡®å¯¼å…¥ï¼š`import 'wj-waterfall-flow'`
2. åœ¨ Nuxt ä¸­ä½¿ç”¨ `<ClientOnly>` åŒ…è£¹
3. äº‹ä»¶åæ˜¯ `load-more`ï¼ˆkebab-caseï¼‰

```vue
<!-- âœ… æ­£ç¡® -->
<waterfall-flow @load-more="handleLoadMore">

<!-- âŒ é”™è¯¯ -->
<waterfall-flow @loadMore="handleLoadMore">
```

### Q4: React ä¸­äº‹ä»¶ç›‘å¬ä¸ç”Ÿæ•ˆï¼Ÿ

æ£€æŸ¥ï¼š
1. ä½¿ç”¨ `useEffect` æ·»åŠ ç›‘å¬å™¨
2. æ¸…ç†å‡½æ•°æ­£ç¡®ç§»é™¤ç›‘å¬å™¨
3. `ref` æ­£ç¡®ç»‘å®šåˆ°ç»„ä»¶

```jsx
useEffect(() => {
  const el = waterfallRef.current;
  if (!el) return; // âš ï¸ æ£€æŸ¥ ref æ˜¯å¦å­˜åœ¨
  
  const handler = (e) => { /* ... */ };
  el.addEventListener('load-more', handler);
  
  return () => el.removeEventListener('load-more', handler);
}, []); // âš ï¸ ä¾èµ–æ•°ç»„ä¸ºç©º
```

---

## ğŸ”„ å‘åå…¼å®¹

æ—§çš„å…¨å±€å‡½æ•°æ–¹å¼ä»ç„¶æ”¯æŒï¼Œä½†**ä¸æ¨èä½¿ç”¨**ï¼š

```html
<!-- æ—§æ–¹å¼ï¼ˆä¸æ¨èï¼‰ -->
<waterfall-flow onLoadMore="loadMore"></waterfall-flow>
<script>
  window.loadMore = function(component) {
    // ...
  };
</script>

<!-- æ–°æ–¹å¼ï¼ˆæ¨èï¼‰ -->
<waterfall-flow id="waterfall"></waterfall-flow>
<script>
  document.getElementById('waterfall')
    .addEventListener('load-more', (event) => {
      // ...
    });
</script>
```

---

## ğŸ“– TypeScript æ”¯æŒ

å®Œæ•´çš„ç±»å‹å®šä¹‰ï¼š

```typescript
import type { WaterfallFlowElement, LoadMoreDetail } from 'wj-waterfall-flow';

const waterfall = document.getElementById('waterfall') as WaterfallFlowElement;

waterfall.addEventListener('load-more', (event: CustomEvent<LoadMoreDetail>) => {
  const { currentCount, finishLoading } = event.detail;
  // å®Œæ•´çš„ç±»å‹æç¤º âœ¨
});
```

---

## ğŸ‰ æ€»ç»“

**æ¨èä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹å¼ï¼š**

1. âœ… Vue: `@load-more="handleLoadMore"`
2. âœ… React: `addEventListener('load-more', handler)`
3. âœ… åŸç”Ÿ: `waterfall.addEventListener('load-more', handler)`

**è®°ä½ä¸¤ä¸ªè¦ç‚¹ï¼š**

1. ğŸ“Œ è°ƒç”¨ `event.preventDefault()`
2. ğŸ“Œ è°ƒç”¨ `finishLoading(hasMore)`

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€

