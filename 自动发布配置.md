# 🤖 自动发布到 npm 配置指南

## 📋 配置步骤

### 1️⃣ 获取 npm Token

```bash
# 登录 npm
npm login

# 生成访问令牌
# 方法一：通过命令行
npm token create

# 方法二：通过网页
# 访问 https://www.npmjs.com/settings/[你的用户名]/tokens
# 点击 "Generate New Token" → 选择 "Automation" 类型
```

**重要：** 复制生成的 token，它只会显示一次！

---

### 2️⃣ 在 GitHub 设置 Secret

1. 打开你的 GitHub 仓库：https://github.com/wuhaoyue/wj-waterfall-flow
2. 进入 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**
4. 填写信息：
   - **Name**: `NPM_TOKEN`
   - **Secret**: 粘贴刚才复制的 npm token
5. 点击 **Add secret**

---

### 3️⃣ 推送代码和工作流

```bash
# 提交工作流文件
git add .github/workflows/publish.yml
git commit -m "ci: 添加自动发布到 npm 的 GitHub Actions"

# 推送到 GitHub
git push origin main
```

---

## 🚀 使用方法

### 方式一：通过 npm version 命令（推荐）

```bash
# 1. 修改代码后，更新版本号并自动创建 tag
npm version patch   # 1.0.0 -> 1.0.1 (bug 修复)
npm version minor   # 1.0.0 -> 1.1.0 (新功能)
npm version major   # 1.0.0 -> 2.0.0 (破坏性变更)

# 2. 推送代码和 tag
git push --follow-tags

# ✨ GitHub Actions 会自动：
#    - 安装依赖
#    - 类型检查
#    - 构建项目
#    - 发布到 npm
```

### 方式二：手动创建 tag

```bash
# 1. 创建 tag
git tag v1.0.1

# 2. 推送 tag
git push origin v1.0.1

# ✨ 自动触发发布
```

---

## 📝 完整工作流程示例

```bash
# 1. 修改代码
# ... 编写代码 ...

# 2. 提交更改
git add .
git commit -m "feat: 添加新功能"

# 3. 更新版本号（自动创建 git tag）
npm version minor

# 4. 推送到 GitHub（包括 tag）
git push --follow-tags

# 5. 等待自动发布
# 访问 https://github.com/wuhaoyue/wj-waterfall-flow/actions
# 查看发布状态
```

---

## 🔍 查看发布状态

1. 访问 GitHub Actions 页面：
   https://github.com/wuhaoyue/wj-waterfall-flow/actions

2. 查看最新的 workflow 运行状态

3. 如果失败，点击查看详细日志

---

## ⚙️ 工作流说明

### 触发条件
- 推送以 `v` 开头的 tag（如 `v1.0.0`、`v2.1.3`）

### 执行步骤
1. ✅ 检出代码
2. ✅ 设置 Node.js 环境
3. ✅ 安装依赖
4. ✅ TypeScript 类型检查
5. ✅ 构建项目
6. ✅ 发布到 npm

### 环境变量
- `NODE_AUTH_TOKEN`: 从 GitHub Secrets 中读取的 npm token

---

## 💡 最佳实践

### 1. 版本号规范

遵循语义化版本（Semantic Versioning）：

- **1.0.0** → **1.0.1**: 修复 bug（patch）
- **1.0.0** → **1.1.0**: 新增功能（minor）
- **1.0.0** → **2.0.0**: 破坏性变更（major）

### 2. 提交信息规范

```bash
feat: 新功能
fix: bug 修复
docs: 文档更新
style: 代码格式化
refactor: 重构
perf: 性能优化
test: 测试
chore: 构建/工具变动
```

### 3. 发布前检查

```bash
# 本地测试
npm run type-check  # 类型检查
npm run build       # 构建
npm run dev         # 测试功能

# 确认一切正常后再发布版本
```

---

## 🔧 自定义配置

### 修改触发条件

编辑 `.github/workflows/publish.yml`:

```yaml
# 只在特定分支发布
on:
  push:
    branches:
      - main
    tags:
      - 'v*'

# 或者手动触发
on:
  workflow_dispatch:
```

### 添加更多检查

```yaml
- name: Run tests
  run: npm test

- name: Lint check
  run: npm run lint
```

---

## ❌ 常见问题

### Q1: 发布失败，提示 "ENEEDAUTH"？

**A**: NPM_TOKEN 未正确配置或已过期
- 重新生成 token
- 更新 GitHub Secret

### Q2: tag 推送了但没有触发发布？

**A**: 检查 tag 格式
- 必须以 `v` 开头，如 `v1.0.0`
- 不能是 `1.0.0` 或 `version-1.0.0`

### Q3: 如何查看发布日志？

**A**: 
1. 进入 GitHub 仓库
2. 点击 "Actions" 标签
3. 选择对应的 workflow 运行记录
4. 查看详细日志

---

## 🎉 配置完成！

现在你可以通过简单的命令发布新版本：

```bash
npm version patch && git push --follow-tags
```

GitHub Actions 会自动完成剩下的工作！🚀

