# 🧪 测试指南

在发布新版本之前，请按照此指南完成所有测试。

## 📦 准备工作

### 1. 安装测试依赖

```bash
npm run test:install
```

这会自动安装所有测试项目的依赖（Vue 3, React, Nuxt 3）。

## 🚀 运行测试

### 方式一：分别测试（推荐）

在3个不同的终端窗口中运行：

```bash
# 终端 1 - Vue 3
npm run test:vue3

# 终端 2 - React
npm run test:react

# 终端 3 - Nuxt 3
npm run test:nuxt3
```

### 方式二：使用脚本（需要 tmux）

```bash
cd tests
./start-all.sh
```

---

## ✅ 测试清单

### 1. Vue 3 测试 (http://localhost:5180)

#### 基本功能
- [ ] 页面正常加载，无报错
- [ ] 瀑布流布局正确显示
- [ ] 项目均匀分布在各列
- [ ] 图片正常加载

#### 事件监听
- [ ] 滚动到底部触发 `load-more` 事件
- [ ] 控制台显示 "✅ Vue 3: load-more 事件触发"
- [ ] 新项目正常添加
- [ ] 可以连续加载多页（至少 5 页）

#### 动态配置
- [ ] 修改行间距，布局实时更新
- [ ] 修改列间距，布局实时更新
- [ ] 修改最小列宽，列数自动调整

#### 方法调用
- [ ] 点击"清空"按钮，所有项目被清除
- [ ] 点击"手动添加 12 个"，正确添加项目
- [ ] 清空后重新滚动，加载继续工作

#### 性能
- [ ] 加载 60+ 项目后滚动流畅
- [ ] 快速滚动无卡顿
- [ ] 内存占用正常（浏览器任务管理器检查）

---

### 2. React 测试 (http://localhost:5181)

#### 基本功能
- [ ] 页面正常加载，无报错
- [ ] 瀑布流布局正确显示
- [ ] 项目均匀分布在各列
- [ ] 图片正常加载

#### 事件监听
- [ ] 滚动到底部触发 `load-more` 事件
- [ ] 控制台显示 "✅ React: load-more 事件触发"
- [ ] 新项目正常添加
- [ ] 可以连续加载多页（至少 5 页）

#### 动态配置
- [ ] 修改行间距，布局实时更新
- [ ] 修改列间距，布局实时更新
- [ ] 修改最小列宽，列数自动调整

#### 方法调用
- [ ] 点击"清空"按钮，所有项目被清除
- [ ] 点击"手动添加 12 个"，正确添加项目
- [ ] 清空后重新滚动，加载继续工作

#### React 特性
- [ ] 组件卸载时无内存泄漏
- [ ] Strict Mode 下无警告
- [ ] useEffect 清理函数正确执行

#### 性能
- [ ] 加载 60+ 项目后滚动流畅
- [ ] 快速滚动无卡顿
- [ ] 内存占用正常

---

### 3. Nuxt 3 测试 (http://localhost:3003)

#### SSR 基本功能
- [ ] 页面正常加载，无报错
- [ ] **重要**: 查看页面源代码（右键 -> 查看网页源代码）
  - 应该看到服务端渲染的 HTML
  - 不应有 `HTMLElement is not defined` 错误
- [ ] 瀑布流组件在客户端正确激活
- [ ] 瀑布流布局正确显示

#### 事件监听
- [ ] 滚动到底部触发 `load-more` 事件
- [ ] 控制台显示 "✅ Nuxt 3: load-more 事件触发"
- [ ] 新项目正常添加
- [ ] 可以连续加载多页（至少 5 页）

#### 动态配置
- [ ] 修改行间距，布局实时更新
- [ ] 修改列间距，布局实时更新
- [ ] 修改最小列宽，列数自动调整

#### 方法调用
- [ ] 点击"清空"按钮，所有项目被清除
- [ ] 点击"手动添加 12 个"，正确添加项目
- [ ] 清空后重新滚动，加载继续工作

#### SSR 特性
- [ ] `<ClientOnly>` 正常工作
- [ ] fallback 内容在加载时显示
- [ ] 刷新页面后功能正常
- [ ] 开发模式下 HMR 工作正常

#### Nuxt 构建测试
```bash
cd tests/nuxt3
npm run build
npm run preview
```
- [ ] 构建成功无错误
- [ ] 预览模式下运行正常
- [ ] 生产构建的页面功能完整

#### 性能
- [ ] 加载 60+ 项目后滚动流畅
- [ ] 快速滚动无卡顿
- [ ] 内存占用正常

---

## 🐛 常见问题排查

### 问题 1: 加载 2 页后停止

**检查**:
- 控制台是否有 "⏸️ 已在加载中" 或 "⏹️ 没有更多数据" 的日志
- 是否正确调用了 `finishLoading(true)`
- IntersectionObserver 是否正常触发（查看 "👀 IntersectionObserver 触发" 日志）

**解决**: 确保在 `finishLoading` 回调中传入 `true`

### 问题 2: 事件监听器不触发

**Vue 3 检查**:
```vue
<!-- 确保使用 kebab-case -->
<waterfall-flow @load-more="handler">
```

**React 检查**:
```jsx
// 确保有清理函数
useEffect(() => {
  waterfall.addEventListener('load-more', handler);
  return () => waterfall.removeEventListener('load-more', handler);
}, []);
```

**Nuxt 检查**:
```vue
<!-- 确保使用 ClientOnly -->
<ClientOnly>
  <waterfall-flow @load-more="handler">
</ClientOnly>
```

### 问题 3: Nuxt SSR 错误

**检查**:
- 是否使用了 `<ClientOnly>` 包装
- 插件是否命名为 `.client.ts`
- 是否在服务端代码中访问了 `window` 或 `document`

### 问题 4: 性能问题

**检查**:
- 打开浏览器 Performance 工具
- 检查是否有大量的重排（reflow）
- 检查图片是否正确使用 `aspect-ratio`
- 查看内存占用是否持续增长

---

## 📊 测试报告

测试完成后，请填写测试报告：

```markdown
## 测试日期：2025-10-XX

### Vue 3
- ✅ 所有测试通过
- ⚠️ 问题：（如果有）

### React
- ✅ 所有测试通过
- ⚠️ 问题：（如果有）

### Nuxt 3
- ✅ 所有测试通过
- ⚠️ SSR 测试通过
- ⚠️ 问题：（如果有）

### 性能
- ✅ 60+ 项目流畅
- ✅ 内存占用正常
- ⚠️ 问题：（如果有）

### 总结
- [ ] 可以发布
- [ ] 需要修复问题

测试人员：___________
```

---

## 🎯 发布前最终检查

完成所有测试后：

1. [ ] 所有测试项目通过
2. [ ] 无控制台错误或警告
3. [ ] 性能测试通过
4. [ ] SSR 测试通过
5. [ ] 文档已更新
6. [ ] CHANGELOG 已更新
7. [ ] 版本号已更新
8. [ ] 构建成功：`npm run build`
9. [ ] 类型检查通过：`npm run type-check`
10. [ ] Git 提交已完成

完成以上所有检查后，即可发布！🚀

---

## 💡 测试技巧

1. **使用浏览器开发工具**
   - Network 面板：查看图片加载
   - Console：查看事件日志
   - Performance：分析性能瓶颈
   - Memory：检查内存泄漏

2. **测试不同场景**
   - 慢速网络（Chrome DevTools -> Network -> Slow 3G）
   - 小屏幕设备（响应式测试）
   - 大量数据（100+ 项目）

3. **自动化测试**
   - 可以考虑使用 Playwright 或 Cypress
   - 编写 E2E 测试脚本
   - 集成到 CI/CD 流程

---

祝测试顺利！如有问题，请查看 `tests/README.md` 或项目文档。🎉

